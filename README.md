#  Planblue_vision — ROS2 Camera Image Pipeline

> A ROS2 Jazzy colcon package that streams camera frames over a topic, overlays timestamps,
> and saves images + metadata to disk.
> Automatically falls back to a synthetic rainbow-frame generator if no webcam is detected.

---

##  Repository Structure

```
planblue_assessment/              ← colcon workspace root
├── src/                          ← source packages (put planblue_vision here)
│   └── planblue_vision/
│       ├── planblue_vision/
│       │   ├── __init__.py
│       │   ├── publisher_node.py
│       │   └── subscriber_node.py
│       ├── package.xml
│       └── setup.cfg
├── build/                        ← auto-generated by colcon build
├── install/                      ← auto-generated by colcon build
├── log/                          ← auto-generated by colcon build
├── output/                       ← auto-generated at runtime by subscriber
│   ├── images/
│   │   └── frame0001_....jpg
│   ├── metadata.json
│   └── .gitkeep
└── .gitignore
```

---

##  System Requirements

| Requirement | Version |
|---|---|
| Ubuntu | 24.04 LTS (Noble Numbat) |
| ROS2 | Jazzy Jalisco |
| Python | 3.12.3 |
| OpenCV | 4.6.0 |
| NumPy | 1.26.4 |

---

##  Installation

### Step 1 — Install ROS2 Jazzy

Follow the official guide:
https://docs.ros.org/en/jazzy/Installation.html

Source the ROS2 environment:
```bash
source /opt/ros/jazzy/setup.bash
```

> **Tip:** Add to `~/.bashrc` to avoid sourcing every session:
> ```bash
> echo "source /opt/ros/jazzy/setup.bash" >> ~/.bashrc
> source ~/.bashrc
> ```

---

### Step 2 — Install Python Dependencies

```bash
pip install opencv-python==4.6.0.66 numpy==1.26.4
```

Install ROS2 bridge packages:
```bash
sudo apt install ros-jazzy-cv-bridge ros-jazzy-sensor-msgs
```

---

### Step 3 — Clone the Repository

```bash
git clone https://github.com/your-username/planblue_assessment.git
cd planblue_assessment
```

---

### Step 4 — Build with Colcon

From the **workspace root** (`~/planblue_assessment`):

```bash
source /opt/ros/jazzy/setup.bash
colcon build --packages-select planblue_vision
```

Expected output:
```
Starting >>> planblue_vision
Finished <<< planblue_vision [x.xx s]

Summary: 1 package finished [x.xx s]
```

---

### Step 5 — Source the Install Overlay

After every build, source the local install overlay:
```bash
source install/setup.bash
```

> **Tip:** Do this in every new terminal after `cd ~/planblue_assessment`.

---

##  Running the Pipeline

Open **two terminals** from `~/planblue_assessment`. Run these in each before the `ros2 run` commands:
```bash
source /opt/ros/jazzy/setup.bash
source install/setup.bash
```

---

### Terminal 1 — Launch the Publisher

```bash
ros2 run planblue_vision publisher_node
```

**Expected output (webcam detected):**
```
[INFO] [image_publisher]: Publisher started - Source: Webcam
[INFO] [image_publisher]: Frame Id: 1 | Time: 2026-02-25 14:00:00.123 | Source: webcam | Status: RUNNING
```

**Expected output (no webcam — synthetic fallback):**
```
[WARN] [image_publisher]: Publisher started - Source: Synthetic (webcam not available)
[INFO] [image_publisher]: Frame Id: 1 | Time: 2026-02-25 14:00:00.123 | Source: synthetic | Status: RUNNING
```

---

### Terminal 2 — Launch the Subscriber

```bash
ros2 run planblue_vision subscriber_node
```

**Expected output:**
```
[INFO] [image_subscriber]: Subscriber started, waiting for image frames
[INFO] [image_subscriber]: Frame Id: 1 | TimeStamp: 2026-02-25 14:00:00.130 | Path: .../output/images/frame0001....jpg
```

---

### Stop Both Nodes

Press `Ctrl+C` in each terminal. Both nodes shut down gracefully:
- **Publisher** releases the webcam handle via `cap.release()`
- **Subscriber** closes all file handles and calls `rclpy.shutdown()`

---

##  Verify the Pipeline is Live

In a **third terminal** (with both overlays sourced):

```bash
# Confirm the topic is active
ros2 topic list

# Monitor publish rate — should read ~10.0 Hz
ros2 topic hz /camera/image/raw

# Inspect message fields without printing pixel arrays
ros2 topic echo /camera/image/raw --no-arr
```

---

##  Output Format

### Saved Images
Saved as `.jpg` in `output/images/` with a unique timestamped filename:
```
frame<id>_<YYYYMMDDHHMMSSfff>.jpg
e.g.  frame0042_20260225140004200.jpg
```

### metadata.json
Running log of every saved frame:
```json
[
    {
        "frame_id": 1,
        "saved_file": "frame0001_20260225140000123.jpg",
        "timestamp": "2026-02-25 14:00:00.123"
    },
    {
        "frame_id": 2,
        "saved_file": "frame0002_20260225140000223.jpg",
        "timestamp": "2026-02-25 14:00:00.223"
    }
]
```

---

##  Configuration

All configurable parameters are in `__init__` of each node:

| Parameter | File | Default | Description |
|---|---|---|---|
| `self.topic_name` | both | `camera/image_raw` | ROS2 topic — must match in both files |
| `self.buffer_size` | both | `10` | QoS message history depth |
| `self.fps` | publisher only | `10` | Publish rate (frames per second) |

> After changing any parameter, rebuild: `colcon build --packages-select planblue_vision`

---

##  Troubleshooting

| Problem | Likely Cause | Fix |
|---|---|---|
| `Package planblue_vision not found` | Install overlay not sourced | Run `source install/setup.bash` |
| Subscriber receives no frames | Publisher not running or topic mismatch | Run `ros2 topic list` — confirm `/camera/image/raw` appears |
| `CvBridgeError` in subscriber logs | Encoding mismatch | Ensure both nodes use `bgr8` encoding |
| `output/` folder not created | No write permission | Run subscriber from `~/planblue_assessment` |
| `dropped_frames` counter rising | Disk I/O too slow | Check disk space with `df -h` |
| `ModuleNotFoundError: cv_bridge` | ROS2 not sourced | Run `source /opt/ros/jazzy/setup.bash` |
| Changes to code not reflected | Package not rebuilt | Run `colcon build --packages-select planblue_vision` |

---

##  License

MIT License — free to use, modify, and distribute.
